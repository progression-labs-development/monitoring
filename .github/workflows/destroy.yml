name: Destroy

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  GCP_PROJECT: christopher-little-dev

jobs:
  destroy:
    name: Destroy Resources
    runs-on: ubuntu-latest
    env:
      PULUMI_CONFIG_PASSPHRASE: ""
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/10492061315/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-pulumi@christopher-little-dev.iam.gserviceaccount.com

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: infra/pulumi/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: infra/pulumi

      - name: Install Pulumi CLI
        uses: pulumi/actions@v6
        with:
          command: version

      - name: Destroy resources
        working-directory: infra/pulumi
        run: |
          pulumi login gs://pulumi-state-christopher-little-dev
          pulumi stack select dev
          pulumi destroy --yes

      - name: Delete secrets
        run: |
          echo "Deleting GCP secrets to avoid conflicts on redeploy..."
          for secret in monitoring-signoz-otlp-endpoint-secret-dev monitoring-signoz-admin-credentials-secret-dev monitoring-mcp-api-key-secret-dev; do
            gcloud secrets delete "$secret" --project=$GCP_PROJECT --quiet 2>/dev/null && \
              echo "✓ Deleted $secret" || echo "✓ $secret already deleted"
          done

      - name: Verify Cleanup
        run: |
          echo "=== Verifying GCP Resource Cleanup ==="
          echo ""

          echo "Checking GCE instances..."
          INSTANCES=$(gcloud compute instances list \
            --project=$GCP_PROJECT \
            --filter="labels.project=monitoring" \
            --format="value(name)" 2>/dev/null || echo "")
          if [ -n "$INSTANCES" ]; then
            echo "WARNING: Found GCE instances: $INSTANCES"
          else
            echo "✓ No monitoring GCE instances found"
          fi

          echo ""
          echo "Checking secrets..."
          for secret in monitoring-signoz-otlp-endpoint-secret-dev monitoring-signoz-admin-credentials-secret-dev monitoring-mcp-api-key-secret-dev; do
            if gcloud secrets describe "$secret" --project=$GCP_PROJECT > /dev/null 2>&1; then
              echo "WARNING: Secret still exists: $secret"
            else
              echo "✓ $secret deleted"
            fi
          done

          echo ""
          echo "=== Verification Complete ==="
