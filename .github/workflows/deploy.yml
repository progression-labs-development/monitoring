name: Deploy

on:
  push:
    branches: [main]
    paths:
      - 'infra/pulumi/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  GCP_PROJECT: christopher-little-dev

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    env:
      PULUMI_CONFIG_PASSPHRASE: ""
      PULUMI_K8S_DELETE_UNREACHABLE: "true"
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        id: gcp-auth
        with:
          workload_identity_provider: projects/10492061315/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-pulumi@christopher-little-dev.iam.gserviceaccount.com
      - uses: google-github-actions/setup-gcloud@v2

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: infra/pulumi/pnpm-lock.yaml
      - name: Configure GCP Artifact Registry
        run: |
          echo "@progression-labs-development:registry=https://europe-west2-npm.pkg.dev/christopher-little-dev/npm-packages/" >> ~/.npmrc
          echo "//europe-west2-npm.pkg.dev/christopher-little-dev/npm-packages/:_authToken=${{ steps.gcp-auth.outputs.access_token }}" >> ~/.npmrc
      - run: pnpm install --frozen-lockfile
        working-directory: infra/pulumi

      - uses: pulumi/setup-pulumi@v2
      - name: Deploy
        working-directory: infra/pulumi
        run: |
          pulumi login gs://pulumi-state-christopher-little-dev
          pulumi stack select dev
          pulumi up --yes

      - name: Wait for SigNoz to become healthy
        run: |
          SIGNOZ_URL=$(gcloud secrets versions access latest \
            --secret=monitoring-signoz-otlp-endpoint-secret-dev \
            --project=$GCP_PROJECT | jq -r .http | sed 's/:4318/:8080/')

          echo "Waiting for SigNoz at $SIGNOZ_URL ..."
          for i in $(seq 1 60); do
            if curl -sf "$SIGNOZ_URL/api/v1/health" > /dev/null 2>&1; then
              echo "SigNoz is healthy after $((i * 10)) seconds"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "::warning::SigNoz did not become healthy within 10 minutes"
              exit 0
            fi
            sleep 10
          done

      - name: Verify SigNoz login and OTLP ingestion
        run: |
          set -e

          # Fetch secrets
          OTLP=$(gcloud secrets versions access latest \
            --secret=monitoring-signoz-otlp-endpoint-secret-dev \
            --project=$GCP_PROJECT)
          CREDS=$(gcloud secrets versions access latest \
            --secret=monitoring-signoz-admin-credentials-secret-dev \
            --project=$GCP_PROJECT)

          OTLP_HTTP=$(echo "$OTLP" | jq -r .http)
          SIGNOZ_URL=$(echo "$CREDS" | jq -r .url)
          EMAIL=$(echo "$CREDS" | jq -r .email)
          PASSWORD=$(echo "$CREDS" | jq -r .password)

          echo "=== Verifying SigNoz Login ==="
          # Retry login up to 5 minutes (admin registration runs after health check passes)
          # Use jq to safely construct JSON (password may contain special chars)
          LOGIN_OK=false
          for attempt in $(seq 1 30); do
            ORG_ID=$(curl -sf "$SIGNOZ_URL/api/v2/sessions/context?email=$EMAIL&ref=$SIGNOZ_URL" \
              | jq -r '.data.orgs[0].id' 2>/dev/null || echo "")

            if [ -n "$ORG_ID" ] && [ "$ORG_ID" != "null" ]; then
              LOGIN_PAYLOAD=$(jq -n --arg e "$EMAIL" --arg p "$PASSWORD" --arg o "$ORG_ID" \
                '{email: $e, password: $p, orgID: $o}')
              LOGIN=$(curl -sf "$SIGNOZ_URL/api/v2/sessions/email_password" \
                -X POST -H "Content-Type: application/json" \
                -d "$LOGIN_PAYLOAD" 2>/dev/null || echo "")

              if echo "$LOGIN" | jq -e '.data.accessToken' > /dev/null 2>&1; then
                echo "✓ Login successful (attempt $attempt)"
                LOGIN_OK=true
                break
              fi
            fi

            echo "  Waiting for admin registration... (attempt $attempt/30)"
            sleep 10
          done

          if [ "$LOGIN_OK" = false ]; then
            echo "::warning::Login not available after 5 minutes - admin registration may have failed"
            exit 0
          fi

          echo ""
          echo "=== Verifying OTLP Ingestion ==="
          NOW=$(date +%s)000000000

          # Send test trace (retry up to 30s for OTel collector startup)
          TRACE_RESP=$(curl -sf --retry 3 --retry-delay 10 --retry-connrefused "$OTLP_HTTP/v1/traces" \
            -X POST -H "Content-Type: application/json" \
            -d "{\"resourceSpans\":[{\"resource\":{\"attributes\":[{\"key\":\"service.name\",\"value\":{\"stringValue\":\"deploy-verify\"}}]},\"scopeSpans\":[{\"scope\":{\"name\":\"deploy-verify\"},\"spans\":[{\"traceId\":\"$(openssl rand -hex 16)\",\"spanId\":\"$(openssl rand -hex 8)\",\"name\":\"verify-span\",\"kind\":1,\"startTimeUnixNano\":\"$NOW\",\"endTimeUnixNano\":\"$NOW\",\"status\":{}}]}]}]}")
          echo "✓ Trace accepted"

          # Send test log
          LOG_RESP=$(curl -sf --retry 3 --retry-delay 10 --retry-connrefused "$OTLP_HTTP/v1/logs" \
            -X POST -H "Content-Type: application/json" \
            -d "{\"resourceLogs\":[{\"resource\":{\"attributes\":[{\"key\":\"service.name\",\"value\":{\"stringValue\":\"deploy-verify\"}}]},\"scopeLogs\":[{\"scope\":{\"name\":\"deploy-verify\"},\"logRecords\":[{\"timeUnixNano\":\"$NOW\",\"severityNumber\":9,\"severityText\":\"INFO\",\"body\":{\"stringValue\":\"deploy verification log\"}}]}]}]}")
          echo "✓ Log accepted"

          # Send test metric
          METRIC_RESP=$(curl -sf --retry 3 --retry-delay 10 --retry-connrefused "$OTLP_HTTP/v1/metrics" \
            -X POST -H "Content-Type: application/json" \
            -d "{\"resourceMetrics\":[{\"resource\":{\"attributes\":[{\"key\":\"service.name\",\"value\":{\"stringValue\":\"deploy-verify\"}}]},\"scopeMetrics\":[{\"scope\":{\"name\":\"deploy-verify\"},\"metrics\":[{\"name\":\"deploy.verify.counter\",\"sum\":{\"dataPoints\":[{\"asInt\":\"1\",\"startTimeUnixNano\":\"$NOW\",\"timeUnixNano\":\"$NOW\"}],\"aggregationTemporality\":2,\"isMonotonic\":true}}]}]}]}")
          echo "✓ Metric accepted"

          echo ""
          echo "=== All Verifications Passed ==="
